<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="author" content="Hugo Corbucci">
    <meta name="description" content="A presentation introducing multistyle tests in golang">
    <meta name="keywords" content="golang,multistyle,tests,pyramid">

    <title>Software and Tests - Binary Systems</title>

    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/night.css">

    <!-- Need to fix the code highlighting to enabled the accessibility one -->
    <!-- <link rel="stylesheet" href="plugin/accessibility/helper.css"> -->

    <!-- Theme used for syntax highlighting of code -->
    <link rel="stylesheet" href="lib/css/monokai.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <script>
      document.write('<script src="http://' + (location.host || 'localhost').split(':')[0] +
      ':35729/livereload.js?snipver=1"></' + 'script>')
    </script>
  </head>
  <body>
    <div class="reveal">
      <div class="slides">
        <section>
          <h1>Software and Tests</h1>
          <h2>Binary Systems</h2>

          <h3><a href="mailto:hcorbucci@digitalocean.com">Hugo Corbucci</a><br/>Staff Engineer for Customer Experience (CX) at <a href="https://www.digitalocean.com">DigitalOcean</a></h3>
        </section>
        <section style="height:100%;">
          <h1><a href="https://www.digitalocean.com"><img src="images/DO_Logo_Horizontal_White.png" alt="DigitalOcean logo" style="border:0; background: none;"/></a></h1>
          <h2>Largest non-billions USD founded cloud</h2>
          <h2>Founded in 2011 in NYC</h2>
          <h2>Worldwide operations (13 datacenters in 7 countries)</h2>
          <h2>Remote first company headquartered in NYC</h2>
          <img src="images/DO-Remotees.png" alt="A world map with some of the DO employee locations (and Hugo in Sao Paulo, Brazil)" style="max-height: 25%">
        </section>
        <section style="height:100%;">
          <h1><a href="https://www.digitalocean.com"><img src="images/DO_Logo_Horizontal_White.png" alt="DigitalOcean logo" style="border:0; background: none;"/></a></h3>
          <h2>500K active customers</h2>
          <h2>80M HTTP requests/day</h2>
          <h2>1.7M active droplets + 90PiB storage</h2>
          <h2>500 deploys/day</h2>
          <h2>1200 services</h2>
          <h2>USD 4.5 Billion valuation</h2>
          <h2>200 Engineers in a 600 people company</h2>
        </section>
        <section style="height:100%;">
          <h3>Not this Binary system</h3>
          <img src="images/Binary-Joke.png" alt="There are only 10 types of people in the world: Those who understand binary and those who don't." style="max-height: 75%">
          <h5>Source: <a href="https://medium.com/@aisatou/binary-its-as-easy-as-01-10-11-f2e3334d92a4" target="_blank" rel="noopener noreferrer">https://medium.com/@aisatou/binary-its-as-easy-as-01-10-11-f2e3334d92a4</a></h5>
        </section>
        <section>
          <h3>This Binary system</h3>
          <img src="images/Binary-Star.gif" alt="A binary star system that is in balance and each star revolves around each other.">
          <h5>By <a href="https://en.wikipedia.org/wiki/Binary_star#/media/File:Orbit2.gif">User:Zhatt</a> - Own work, Public Domain, https://commons.wikimedia.org/w/index.php?curid=280053</h5>
        </section>
        <section>
          <h2>The context:</h2>
          <h2 class="fragment">Micro-services</h2>
          <h3 class="fragment">Small request/response services with (or without) dependencies</h3>
        </section>
        <section>
          <h1>DigitalOcean's overall architecture</h1>
          <h3 class="fragment">Few (3) legacy <a href="https://rubyonrails.org/" target="_blank" rel="noopener noreferrer">Ruby on Rails</a> monolithic applications</h3>
          <h3 class="fragment">Migrating to <a href="https://golang.org/" target="_blank" rel="noopener noreferrer">Golang</a> microservices since 2015 using <a href="https://grpc.io/" target="_blank" rel="noopener noreferrer">gRPC</a>/<a href="https://developers.google.com/protocol-buffers" target="_blank" rel="noopener noreferrer">protobufs</a></h3>
          <h3 class="fragment">Different datastores depending on the needs highlighting <a href="https://www.mysql.com/" target="_blank" rel="noopener noreferrer">MySQL</a> and <a href="https://etcd.io/" target="_blank" rel="noopener noreferrer">etcd</a></h3>
        </section>
        <section>
          <h2 style="margin-bottom: 5rem"><a href="https://martinfowler.com/articles/practical-test-pyramid.html" target="_blank" rel="noopener noreferrer">The test pyramid:</a></h2>
          <div style="display:flex;flex-flow: column;">
            <h2 class="fragment" style="order: 3">VERY MANY unit tests</h2>
            <h3 class="fragment" style="order: 2">Fair # of integration tests</h3>
            <h4 class="fragment" style="order: 1">Some end to end tests</h4>
          </div>
        </section>
        <section>
          <h2>Why does the pyramid exist?</h2>
          <h3 class="fragment">Unit tests are fast<br/>but don't catch integration problems</h3>
          <h3 class="fragment">Integration tests are slower and harder to debug<br/>but they catch more problems</h3>
          <h3 class="fragment">End to end tests verify what the user sees<br/>but are slower and less reliable</h3>
        </section>
        <section>
          <h2>The problems that come with the pyramid:</h2>
          <h3 class="fragment">Unit tests that are very simple and don't really catch real problems</h3>
          <h3 class="fragment">Integration tests that repeat a lot of setup/verifications from unit tests</h3>
          <h3 class="fragment">End to end tests only for happy paths that are most commonly exercised</h3>
        </section>
        <section>
          <h2>The solution:</h2>
          <h2 class="fragment"><a href="https://martinfowler.com/articles/injection.html" target="_blank" rel="noopener noreferrer">Dependency Injection</a></h2>
        </section>
        <section>
          <h1>THE END!</h1>
          <h5>The implementation of this idea is left as an exercise to the audience</h5>
        </section>
        <section>
          <h2>Dependency Injection</h2>
        </section>
        <section>
          <h2>Test is code</h2>
          <h2 class="fragment">that depends on the code under test</h2>
          <h2 class="fragment">to output üëç or üëé</h2>
        </section>
        <section>
          <h2>A go http webserver example</h2>
          <h3><a href="https://github.com/hugocorbucci/multitest-go-example" target="_blank" rel="noopener noreferrer">https://github.com/hugocorbucci/multitest-go-example</a></h3>
        </section>
        <section>
            <pre>
              <code class="hljs go" data-trim data-noescape data-line-numbers="2,6" style="font-size:200%;max-height:initial;">
                func main() {
                  s := server.NewHTTPServer()
                  ll := log.New(os.Stdout, "HTTP", 0)
                  addr := net.JoinHostPort("", "8080")

                  if err := http.ListenAndServe(addr, s); err != nil {
                    ll.Fatal("HTTP(s) server failed")
                  }
                }
              </code>
            </pre>
            <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide11/cmd/server/main.go#L16-L24" target="_blank" rel="noopener noreferrer">cmd/server/main.go</a>
        </section>
        <section>
            <pre>
              <code class="hljs go" data-trim data-noescape data-line-numbers="7,12-16" style="font-size:200%;max-height:initial;">
                type Server struct {
                  *mux.Router
                }

                func NewHTTPServer() *Server {
                  r := mux.NewRouter()
                  r.HandleFunc("/", helloWorld).Methods(http.MethodGet)
                
                  return &Server{r}
                }
                
                func helloWorld(w http.ResponseWriter, req *http.Request) {
                  msg := "Hello, world"
                  fmt.Println("Responding request")
                  w.Write([]byte(msg))
                }
              </code>
            </pre>
            <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide12/internal/server/http.go#L10-L27" target="_blank" rel="noopener noreferrer">internal/server/http.go</a><br/>
            <a href="https://github.com/gorilla/mux" target="_blank" rel="noopener noreferrer" style="font-size:50%;">https://github.com/gorilla/mux</a>
        </section>
        <section>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="" style="font-size:200%;max-height:initial;">
                func TestHelloWord(t *testing.T) {
                  w := httptest.NewRecorder()
                
                  helloWorld(w, nil)
                
                  require.Equal(t, http.StatusOK, w.Code, "expected status code to match")
                  body := string(w.Body.Bytes())
                  assert.Equal(t, "Hello, world", body, "expected body to match")
                }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide13/internal/server/http_internal_test.go#L12-L20" target="_blank" rel="noopener noreferrer">internal/server/http_internal_test.go</a><br/>
          <a href="https://github.com/stretchr/testify" target="_blank" rel="noopener noreferrer" style="font-size:50%;">https://github.com/stretchr/testify</a>
          <h3 class="fragment">This doesn't test the integration with the mux library (or the NewServer code)</h3>
        </section>
        <section>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="2,4-6" style="font-size:200%;max-height:initial;">
                func TestHomeReturnsHelloWorldLocal(t *testing.T) {
                  s := server.NewHTTPServer()

                  w := httptest.NewRecorder()
                  httpReq := httptest.NewRequest(http.MethodGet, "/", nil)
                  s.ServeHTTP(w, httpReq)
                
                  require.Equal(t, http.StatusOK, w.Code, "expected status code to match for req %+v", httpReq)
                  body := string(w.Body.Bytes())
                  assert.Equal(t, "Hello, world", body, "expected body to match")
                }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide14/internal/server/http_test.go#L14-L24" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
          <h3 class="fragment">This is better, but doesn't handle HTTP (de)serialization</h3>
        </section>
        <section>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="3-15,17,20,22" style="font-size:200%;max-height:initial;">
              func TestHomeReturnsHelloWorld(t *testing.T) {
                s := server.NewHTTPServer()
                listener, err := net.Listen("tcp", "localhost:0")
                if err != nil {
                  t.Fatalf("could not listen for HTTP requests: %+v", err)
                }
                baseURL := "http://" + listener.Addr().String()
                srvr := http.Server{Addr: baseURL, Handler: s}
                go srvr.Serve(listener)
                defer func() {
                  if err := srvr.Shutdown(context.Background()); err != nil {
                    t.Logf("could not shutdown http server: %+v", err)
                  }
                }()
                httpReq, err := http.NewRequest(http.MethodGet, baseURL+"/", nil)
                require.NoError(t, err, "could not create GET / request")
                resp, err := http.DefaultClient.Do(httpReq)
                require.NoError(t, err, "error making request %+v", httpReq)
                require.Equal(t, http.StatusOK, resp.StatusCode, "expected status code to match for req %+v", httpReq)
                body, err := readBodyFrom(resp)
                require.NoError(t, err, "unexpected error reading response body")
                assert.Equal(t, "Hello, world", body, "expected body to match")
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide15/internal/server/http_test.go#L29-L55" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
          <h3 class="fragment">Now everything is tested: bringing the server up, executing the code and closing it all</h3>
        </section>
        <section>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="2,4,6-8,11-13,17-20" style="font-size:200%;max-height:initial;">
              func TestHomeReturnsHelloWorldLocal(t *testing.T) {
                s := server.NewHTTPServer()
                w := httptest.NewRecorder()
                httpReq := httptest.NewRequest(http.MethodGet, "/", nil)
                s.ServeHTTP(w, httpReq)
                require.Equal(t, http.StatusOK, w.Code, "expected status code to match for req %+v", httpReq)
                body := string(w.Body.Bytes())
                assert.Equal(t, "Hello, world", body, "expected body to match")
              }
              func TestHomeReturnsHelloWorld(t *testing.T) {
                baseURL, stop := startTestingHTTPServer(t)
                defer stop()
                httpReq, err := http.NewRequest(http.MethodGet, baseURL+"/", nil)
                require.NoError(t, err, "could not create GET / request")
                resp, err := http.DefaultClient.Do(httpReq)
                require.NoError(t, err, "error making request %+v", httpReq)
                require.Equal(t, http.StatusOK, resp.StatusCode, "expected status code to match for req %+v", httpReq)
                body, err := readBodyFrom(resp)
                require.NoError(t, err, "unexpected error reading response body")
                assert.Equal(t, "Hello, world", body, "expected body to match")
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide16/internal/server/http_test.go#L17-L42" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
          <h3 class="fragment">A LOT of duplication! We can refactor this</h3>
        </section>
        <section>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="12-19,27-34" style="line-height:initial;font-size:125%;max-height:initial;">
              func TestHomeReturnsHelloWorldLocal(t *testing.T) {
                s := server.NewHTTPServer()
                baseURL := ""
                makeRequest := func(r *http.Request) (*http.Response, error) {
                  w := httptest.NewRecorder()
                  s.ServeHTTP(w, r)
                  return &http.Response{
                    StatusCode: w.Code,
                    Body:       ioutil.NopCloser(bytes.NewReader(w.Body.Bytes())),
                  }, nil
                }
                httpReq, err := http.NewRequest(http.MethodGet, baseURL+"/", nil)
                require.NoError(t, err, "could not create GET / request")
                resp, err := makeRequest(httpReq)
                require.NoError(t, err, "error making request %+v", httpReq)
                require.Equal(t, http.StatusOK, resp.StatusCode, "expected status code to match for req %+v", httpReq)
                body, err := readBodyFrom(resp)
                require.NoError(t, err, "unexpected error reading response body")
                assert.Equal(t, "Hello, world", body, "expected body to match")
              }
              func TestHomeReturnsHelloWorld(t *testing.T) {
                baseURL, stop := startTestingHTTPServer(t)
                defer stop()
                makeRequest := func(r *http.Request) (*http.Response, error) {
                  return http.DefaultClient.Do(r)
                }
                httpReq, err := http.NewRequest(http.MethodGet, baseURL+"/", nil)
                require.NoError(t, err, "could not create GET / request")
                resp, err := makeRequest(httpReq)
                require.NoError(t, err, "error making request %+v", httpReq)
                require.Equal(t, http.StatusOK, resp.StatusCode, "expected status code to match for req %+v", httpReq)
                body, err := readBodyFrom(resp)
                require.NoError(t, err, "unexpected error reading response body")
                assert.Equal(t, "Hello, world", body, "expected body to match")
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide17/internal/server/http_test.go#L18-L60" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
          <h3 class="fragment">That's a lot closer</h3>
        </section>
        <section>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="1-14,16-18,29-31" style="line-height:initial;font-size:125%;max-height:initial;">
                type HTTPClient interface {
                  Do(r *http.Request) (*http.Response, error)
                }
                type InMemoryHTTPClient struct {
                  server *server.Server
                }
                func (c *InMemoryHTTPClient) Do(r *http.Request) (*http.Response, error) {
                  w := httptest.NewRecorder()
                  c.server.ServeHTTP(w, r)
                  return &http.Response{
                    StatusCode: w.Code,
                    Body:       ioutil.NopCloser(bytes.NewReader(w.Body.Bytes())),
                  }, nil
                }
                func TestHomeReturnsHelloWorldLocal(t *testing.T) {
                  s := server.NewHTTPServer()
                  httpClient := &InMemoryHTTPClient{server: s}
                  baseURL := ""
                  httpReq, err := http.NewRequest(http.MethodGet, baseURL+"/", nil)
                  require.NoError(t, err, "could not create GET / request")
                  resp, err := httpClient.Do(httpReq)
                  require.NoError(t, err, "error making request %+v", httpReq)
                  require.Equal(t, http.StatusOK, resp.StatusCode, "expected status code to match for req %+v", httpReq)
                  body, err := readBodyFrom(resp)
                  require.NoError(t, err, "unexpected error reading response body")
                  assert.Equal(t, "Hello, world", body, "expected body to match")
                }
                func TestHomeReturnsHelloWorld(t *testing.T) {
                  baseURL, stop := startTestingHTTPServer(t)
                  defer stop()
                  httpClient := http.DefaultClient
                  httpReq, err := http.NewRequest(http.MethodGet, baseURL+"/", nil)
                  require.NoError(t, err, "could not create GET / request")
                  resp, err := httpClient.Do(httpReq)
                  require.NoError(t, err, "error making request %+v", httpReq)
                  require.Equal(t, http.StatusOK, resp.StatusCode, "expected status code to match for req %+v", httpReq)
                  body, err := readBodyFrom(resp)
                  require.NoError(t, err, "unexpected error reading response body")
                  assert.Equal(t, "Hello, world", body, "expected body to match")
                }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide18/internal/server/http_test.go#L18-L60" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
          <h3 class="fragment">Now it's obvious, the dependencies are different, but the test is the same</h3>
        </section>
        <section>
          <h2>Refactor to inject dependencies</h2>
          <div class="fragment">
            <pre>
              <code class="hljs go" data-trim data-noescape data-line-numbers="1,3-11,14-18" style="font-size:200%;max-height:initial;">
                func withDependencies(baseT *testing.T, test func(*testing.T, string, HTTPClient)) {
                  testStates := map[string]func(*testing.T) (string, func(), HTTPClient){
                    "unitServerTest":   func(*testing.T) (string, func(), HTTPClient) {
                      s := server.NewHTTPServer()
                      httpClient := &InMemoryHTTPClient{server: s}
                      return "", func() {}, httpClient
                    },
                    "integrationServerTest": func(t *testing.T) (string, func(), HTTPClient) {
                      baseURL, stop := startTestingHTTPServer(t)
                      return baseURL, stop, http.DefaultClient
                    },
                  }
                  for name, dep := range testStates {
                    baseT.Run(name, func(t *testing.T) {
                      baseURL, stop, client := dep(t)
                      defer stop()
                      test(t, baseURL, client)
                    })
                  }
                }
              </code>
            </pre>
            <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide19/internal/server/http_test.go#L68-L87" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
          </div>
        </section>
        <section>
          <h2>Now we can erase TestHomeReturnsHelloWorldLocal and use TestHomeReturnsHelloWorld</h2>
          <div class="fragment">
            <pre>
              <code class="hljs go" data-trim data-noescape data-line-numbers="2" style="font-size:200%;max-height:initial;">
                func TestHomeReturnsHelloWorld(t *testing.T) {
                  withDependencies(t, func(t *testing.T, baseURL string, httpClient HTTPClient) {
                    httpReq, err := http.NewRequest(http.MethodGet, baseURL+"/", nil)
                    require.NoError(t, err, "could not create GET / request")
  
                    resp, err := httpClient.Do(httpReq)
                    require.NoError(t, err, "error making request %+v", httpReq)
                  
                    require.Equal(t, http.StatusOK, resp.StatusCode, "expected status code to match for req %+v", httpReq)
                    body, err := readBodyFrom(resp)
                    require.NoError(t, err, "unexpected error reading response body")
                    assert.Equal(t, "Hello, world", body, "expected body to match")
                  })
                }
              </code>
            </pre>
            <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide20/internal/server/http_test.go#L36-L49" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
          </div>
        </section>
        <section>
          <h2>A little profit</h2>
          <pre class="fragment">
            <code class="hljs bash" data-trim data-noescape data-line-numbers="1,6-14" style="font-size:200%;max-height:initial;">
              $ $ go test -v ./...
              ?   	github.com/hugocorbucci/multitest-go-example/cmd/server	[no test files]
              === RUN   TestHelloWord
              Responding request
              --- PASS: TestHelloWord (0.00s)
              === RUN   TestHomeReturnsHelloWorld
              === RUN   TestHomeReturnsHelloWorld/unitServerTest
              Responding request
              === RUN   TestHomeReturnsHelloWorld/integrationServerTest
              Responding request
              --- PASS: TestHomeReturnsHelloWorld (0.00s)
                  --- PASS: TestHomeReturnsHelloWorld/unitServerTest (0.00s)
                  --- PASS: TestHomeReturnsHelloWorld/integrationServerTest (0.00s)
              PASS
              ok  	github.com/hugocorbucci/multitest-go-example/internal/server	0.148s
            </code>
          </pre>
        </section>
        <section>
          <h3>We can profit more<br/>Add the ability to test an external service</h3>
          <div class="fragment">
            <pre>
              <code class="hljs go" data-trim data-noescape data-line-numbers="2,21-23" style="font-size:150%;max-height:initial;">
                func withDependencies(baseT *testing.T, test func(*testing.T, string, HTTPClient)) {
                  if len(os.Getenv("TARGET_URL")) == 0 {
                    testStates := map[string]func(*testing.T) (string, func(), HTTPClient){
                      "unitServerTest":   func(*testing.T) (string, func(), HTTPClient) {
                        s := server.NewHTTPServer()
                        httpClient := &InMemoryHTTPClient{server: s}
                        return "", func() {}, httpClient
                      },
                      "integrationServerTest": func(t *testing.T) (string, func(), HTTPClient) {
                        baseURL, stop := startTestingHTTPServer(t)
                        return baseURL, stop, http.DefaultClient
                      },
                    }
                    for name, dep := range testStates {
                      baseT.Run(name, func(t *testing.T) {
                        baseURL, stop, client := dep(t)
                        defer stop()
                        test(t, baseURL, client)
                      })
                    }
                  } else {
                    test(baseT, os.Getenv("TARGET_URL"), http.DefaultClient)
                  }
                }
              </code>
            </pre>
            <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide22/internal/server/http_test.go#L36-L49" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
          </div>
        </section>
        <section>
          <h2>More profit</h2>
          <pre class="fragment">
            <code class="hljs bash" data-trim data-noescape data-line-numbers="1,6-7,10,15-16" style="font-size:200%;max-height:initial;">
              $ TARGET_URL=http://localhost:8080 go test -v ./...
              ?   	github.com/hugocorbucci/multitest-go-example/cmd/server	[no test files]
              === RUN   TestHelloWord
              Responding request
              --- PASS: TestHelloWord (0.00s)
              === RUN   TestHomeReturnsHelloWorld
              --- PASS: TestHomeReturnsHelloWorld (0.00s)
              PASS
              ok  	github.com/hugocorbucci/multitest-go-example/internal/server	0.034s
              $ TARGET_URL=http://138.197.59.82 go test -v ./...
              ?   	github.com/hugocorbucci/multitest-go-example/cmd/server	[no test files]
              === RUN   TestHelloWord
              Responding request
              --- PASS: TestHelloWord (0.00s)
              === RUN   TestHomeReturnsHelloWorld
              --- PASS: TestHomeReturnsHelloWorld (0.02s)
              PASS
              ok  	github.com/hugocorbucci/multitest-go-example/internal/server	0.065s
            </code>
          </pre>
        </section>
        <section>
          <h2>Same code, in memory tests ("unit"), local ("integration") or remote ("smoke")!</h2>
          <pre>
            <code class="hljs go" data-trim data-noescape style="font-size:200%;max-height:initial;">
              func TestHomeReturnsHelloWorld(t *testing.T) {
                withDependencies(t, func(baseURL string, httpClient HTTPClient) {
                  httpReq, err := http.NewRequest(http.MethodGet, baseURL+"/", nil)
                  require.NoError(t, err, "could not create GET / request")

                  resp, err := httpClient.Do(httpReq)
                  require.NoError(t, err, "error making request %+v", httpReq)

                  require.Equal(t, http.StatusOK, resp.StatusCode, "expected status code to match for req %+v", httpReq)
                  body, err := readBodyFrom(resp)
                  require.NoError(t, err, "unexpected error reading response body")
                  assert.Equal(t, "Hello, world", body, "expected body to match")
                })
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide24/internal/server/http_test.go#L37-L50" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
        </section>
        <section>
          <h1>Pause for questions</h1>
          <h3>Next step:<br/>add a dependency to the service itself</h3>
        </section>
        <section>
          <h2>Adding a dependency to the system (and the test)</h2>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="5-13" style="font-size:200%;max-height:initial;">
              func main() {
                ll := log.New(os.Stdout, "HTTP - ", 0)
                addr := net.JoinHostPort("", port)

                dbConn := os.Getenv("DB_CONN")
                if len(dbConn) == 0 {
                  dbConn = "root:sekret@tcp(localhost:3306)/multitest"
                }
                db := initializeStore(context.Background(), dbConn, ll)
                repo := storage.NewSQLStore(db)
              
                s := server.NewHTTPServer(repo)
                if err := http.ListenAndServe(addr, s); err != nil {
                  ll.Fatal("HTTP(s) server failed")
                }
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide26/cmd/server/main.go#L22-L37" target="_blank" rel="noopener noreferrer">cmd/server/main.go</a>
        </section>
        <section>
          <h2>Fixing the server</h2>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="1-3,6,9,15" style="font-size:200%;max-height:initial;">
              type httpHandler struct {
                repo storage.Repository
              }
              // NewHTTPServer creates a new server
              func NewHTTPServer(repo storage.Repository) *Server {
                handler := &httpHandler{repo}
              
                r := mux.NewRouter()
                r.HandleFunc("/", handler.helloWorld).Methods(http.MethodGet)
              
                return &Server{
                  r,
                }
              }
              func (h *httpHandler) helloWorld(w http.ResponseWriter, req *http.Request) {
                msg := "Hello, world"
                fmt.Println("Responding request")
                w.Write([]byte(msg))
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide27/internal/server/http.go#L17-L35" target="_blank" rel="noopener noreferrer">internal/server/http.go</a>
        </section>
        <section>
          <h2>Fixing the unit tests</h2>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="2,5" style="font-size:200%;max-height:initial;">
              func TestHelloWord(t *testing.T) {
                handler := &httpHandler{}

                w := httptest.NewRecorder()
                handler.helloWorld(w, nil)

                require.Equal(t, http.StatusOK, w.Code, "expected status code to match")
                body := string(w.Body.Bytes())
                assert.Equal(t, "Hello, world", body, "expected body to match")
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide28/internal/server/http_internal_test.go#L12-L22" target="_blank" rel="noopener noreferrer">internal/server/http_internal_test.go</a>
        </section>
        <section>
          <h3>Fixing the integration tests</h3>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="5-7,11-14" style="font-size:150%">
              func withDependencies(baseT *testing.T, test func(*testing.T, string, HTTPClient)) {
                if len(os.Getenv("TARGET_URL")) == 0 {
                  testStates := map[string]func(*testing.T) (string, func(), HTTPClient){
                    "unitServerTest": func(t *testing.T) (string, func(), HTTPClient) {
                      repo := stubs.NewStubRepository(nil)
                      s := server.NewHTTPServer(repo)
                      httpClient := &InMemoryHTTPClient{server: s}
                      return "", func() {}, httpClient
                    },
                    "integrationServerTest": func(t *testing.T) (string, func(), HTTPClient) {
                      ctx := context.Background()
                      inMemoryStore, err := sqltesting.NewMemoryStore(ctx, sqltesting.NewTestingLog(t))
                      require.NoError(t, err, "error creating in memory store")
                      baseURL, stop := startTestingHTTPServer(t, inMemoryStore)
                      return baseURL, stop, http.DefaultClient
                    },
                  }
                  for name, dep := range testStates {
                    baseT.Run(name, func(t *testing.T) {
                      baseURL, stop, client := dep(t)
                      defer stop()
                      test(t, baseURL, client)
                    })
                  }
                } else {
                  test(baseT, os.Getenv("TARGET_URL"), http.DefaultClient)
                }
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide29/internal/server/http_test.go#L54-L81" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
        </section>
        <section>
          <h2>Fixing the integration tests (2)</h2>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="1,3" style="font-size:150%;max-height:initial;">
              func startTestingHTTPServer(t *testing.T, inMemoryStore *sqltesting.MemoryStore) (string, func()) {
                ctx := context.Background()
                s := server.NewHTTPServer(inMemoryStore)
              
                listener, err := net.Listen("tcp", "localhost:0")
                if err != nil {
                  t.Fatalf("could not listen for HTTP requests: %+v", err)
                }
                addr := "http://" + listener.Addr().String()
                srvr := http.Server{Addr: addr, Handler: s}
              
                go srvr.Serve(listener)
                return addr, func() {
                  if err := srvr.Shutdown(ctx); err != nil {
                    t.Logf("could not shutdown http server: %+v", err)
                  }
                }
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide30/internal/server/http_test.go#L83-L100" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
        </section>
        <section>
          <h2>What is this magic MemoryStore?</h2>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="2-3,15-16,24" style="font-size:150%;max-height:initial;">
              // NewMemoryStore returns a sqlite "in-memory" repository for local tests.
              func NewMemoryStore(ctx context.Context, l *log.Logger) (*MemoryStore, error) {
                db, err := NewSQLiteDB(ctx, l)
                if err != nil {
                  return nil, err
                }
              
                return &MemoryStore{
                  DB:    db,
                  Store: storage.NewSQLStore(db),
                }, nil
              }
              
              // NewSQLiteDB creates a SQLite DB with the default structure
              func NewSQLiteDB(ctx context.Context, l *log.Logger) (*sql.DB, error) {
                return sql.Open("sqlite3", "file::memory:?mode=memory&cache=shared")
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide31/internal/storage/sqltesting/memory.go#L24-L40" target="_blank" rel="noopener noreferrer">internal/storage/sqltesting/memory.go</a>
        </section>
        <section>
          <h2>Adding a feature</h2>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="7" style="font-size:200%;max-height:initial;">
              // NewHTTPServer creates a new server
              func NewHTTPServer(repo storage.Repository) *Server {
                handler := &httpHandler{repo}
              
                r := mux.NewRouter()
                r.HandleFunc("/", handler.helloWorld).Methods(http.MethodGet)
                r.HandleFunc("/s/{short:[a-f0-9]+}", handler.shortURL).Methods(http.MethodGet)
              
                return &Server{
                  r,
                }
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide32/internal/server/http.go#L22-L31" target="_blank" rel="noopener noreferrer">internal/server/http.go</a>
        </section>
        <section>
          <h2>Adding a feature</h2>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="" style="font-size:200%;max-height:initial;">
              func (h *httpHandler) shortURL(w http.ResponseWriter, req *http.Request) {
                ctx := req.Context()
                short := mux.Vars(req)["short"]
                if len(short) != 12 {
                  w.WriteHeader(http.StatusNotFound)
                  return
                }
                longURL, err := h.repo.ExpandShortURL(ctx, short)
                if err != nil {
                  if err == sql.ErrNoRows {
                    w.WriteHeader(http.StatusNotFound)
                    w.Write([]byte("404 page not found\n"))
                  } else {
                    w.WriteHeader(http.StatusInternalServerError)
                    w.Write([]byte(fmt.Sprintf("%+v", err)))
                  }
                  return
                }
                w.WriteHeader(http.StatusFound)
                w.Header().Set("Location", longURL)
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide33/internal/server/http.go#L39-L62" target="_blank" rel="noopener noreferrer">internal/server/http.go</a>
        </section>
        <section>
          <h2>Adding a feature</h2>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="8" style="font-size:200%;max-height:initial;">
              func (h *httpHandler) shortURL(w http.ResponseWriter, req *http.Request) {
                ctx := req.Context()
                short := mux.Vars(req)["short"]
                if len(short) != 12 {
                  w.WriteHeader(http.StatusNotFound)
                  return
                }
                longURL, err := h.repo.ExpandShortURL(ctx, short)
                if err != nil {
                  if err == sql.ErrNoRows {
                    w.WriteHeader(http.StatusNotFound)
                  } else {
                    w.WriteHeader(http.StatusInternalServerError)
                    w.Write([]byte(fmt.Sprintf("%+v", err)))
                  }
                  return
                }
                w.WriteHeader(http.StatusFound)
                w.Header().Set("Location", longURL)
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide34/internal/server/http.go#L48" target="_blank" rel="noopener noreferrer">internal/server/http.go</a>
        </section>
        <section>
          <h2>Testing</h2>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="" style="font-size:200%;max-height:initial;">
              func TestShortURLReturnsNotFoundForInvalidURL(baseT *testing.T) {
                withDependencies(baseT, func(t *testing.T, baseURL string, httpClient HTTPClient) {
                  httpReq, err := http.NewRequest(http.MethodGet, baseURL+"/s/invalid", nil)
                  require.NoError(t, err, "could not create GET / request")
              
                  resp, err := httpClient.Do(httpReq)
                  require.NoError(t, err, "error making request %+v", httpReq)
              
                  require.Equal(t, http.StatusNotFound, resp.StatusCode, "expected status code to match for req %+v", httpReq)
                  body, err := readBodyFrom(resp)
                  require.NoError(t, err, "unexpected error reading response body")
                  assert.Equal(t, "404 page not found\n", body, "expected body to match")
                })
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide35/internal/server/http_test.go#L54-L66" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
        </section>
        <section>
          <h2>Testing</h2>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="" style="font-size:200%;max-height:initial;">
              func TestShortURLReturnsNotFoundForUnknown(baseT *testing.T) {
                withDependencies(baseT, func(t *testing.T, baseURL string, httpClient HTTPClient) {
                  httpReq, err := http.NewRequest(http.MethodGet, baseURL+"/s/123456789012", nil)
                  require.NoError(t, err, "could not create GET / request")
              
                  resp, err := httpClient.Do(httpReq)
                  require.NoError(t, err, "error making request %+v", httpReq)
              
                  require.Equal(t, http.StatusNotFound, resp.StatusCode, "expected status code to match for req %+v", httpReq)
                  body, err := readBodyFrom(resp)
                  require.NoError(t, err, "unexpected error reading response body")
                  assert.Equal(t, "404 page not found\n", body, "expected body to match")
                })
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide36/internal/server/http_test.go#L68-L80" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
        </section>
        <section>
          <h2>Testing</h2>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="4-10" style="font-size:200%;max-height:initial;">
              func TestShortURLReturnsFoundForValidURL(baseT *testing.T) {
                withDependencies(baseT, func(t *testing.T, baseURL string, httpClient HTTPClient) {
                  mocking := false
                  input := "123456789012"
                  output := "https://www.digitalocean.com"
                  if mocking {
                    // TODO: Mockar
                  } else {
                    // TODO: cadastrar a URL
                  }
                  httpReq, err := http.NewRequest(http.MethodGet, baseURL+"/s/"+input, nil)
                  require.NoError(t, err, "could not create GET / request")
                  resp, err := httpClient.Do(httpReq)
                  require.NoError(t, err, "error making request %+v", httpReq)
                  require.Equal(t, http.StatusFound, resp.StatusCode, "expected status code to match for req %+v", httpReq)
                  body, err := readBodyFrom(resp)
                  require.NoError(t, err, "unexpected error reading response body")
                  assert.Equal(t, "", body, "expected body to match")
                  assert.Equal(t, output, resp.Header.Get("Location"), "expected location to match")
                })
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide37/internal/server/http_test.go#L82-L105" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
          <h3 class="fragment">Uh oh, that's a problem! How to fix it?</h3>
        </section>
        <section>
          <h2>The solution:</h2>
          <h2 class="fragment">Dependency Injection</h2>
        </section>
        <section>
          <pre style="margin:0;">
            <code class="hljs go" data-trim data-noescape data-line-numbers="1-4,6,8-9,13,15,20,31" style="font-size:150%;max-height:initial;">
              // TestDependencies encapsulates the dependencies needed to run a test
              type TestDependencies struct {
                BaseURL    string
                HTTPClient HTTPClient
              }
              func withDependencies(baseT *testing.T, test func(*testing.T, *TestDependencies)) {
                if len(os.Getenv("TARGET_URL")) == 0 {
                  testStates := map[string]func(*testing.T) (*TestDependencies, func()){
                    "unitServerTest": func(t *testing.T) (*TestDependencies, func()) {
                      repo := stubs.NewStubRepository(nil)
                      s := server.NewHTTPServer(repo)
                      httpClient := &InMemoryHTTPClient{server: s}
                      return &TestDependencies{BaseURL: "", HTTPClient: httpClient}, func() {}
                    },
                    "integrationServerTest": func(t *testing.T) (*TestDependencies, func()) {
                      ctx := context.Background()
                      inMemoryStore, err := sqltesting.NewMemoryStore(ctx, sqltesting.NewTestingLog(t))
                      require.NoError(t, err, "error creating in memory store")
                      baseURL, stop := startTestingHTTPServer(t, inMemoryStore)
                      return &TestDependencies{BaseURL: baseURL, HTTPClient: http.DefaultClient}, stop
                    },
                  }
                  for name, dep := range testStates {
                    baseT.Run(name, func(t *testing.T) {
                      deps, stop := dep(t)
                      defer stop()
                      test(t, deps)
                    })
                  }
                } else {
                  test(baseT, &TestDependencies{BaseURL: os.Getenv("TARGET_URL"), HTTPClient: http.DefaultClient})
                }
              }
            </code>
          </pre>
        </section>
        <section>
          <pre style="margin:0;">
            <code class="hljs go" data-trim data-noescape data-line-numbers="" style="font-size:150%;">
              func withDependencies(baseT *testing.T, test func(*testing.T, *TestDependencies)) {
                if len(os.Getenv("TARGET_URL")) == 0 {
                  testStates := map[string]func(*testing.T) (*TestDependencies, func()){
                    "unitServerTest":        unitDependencies,
                    "integrationServerTest": integrationDependencies,
                  }
                  for name, dep := range testStates {
                    baseT.Run(name, func(t *testing.T) {
                      deps, stop := dep(t)
                      defer stop()
                      test(t, deps)
                    })
                  }
                } else {
                  test(baseT, smokeDependencies(baseT))
                }
              }
              func unitDependencies(t *testing.T) (*TestDependencies, func()) {
                repo := stubs.NewStubRepository(nil)
                s := server.NewHTTPServer(repo)
                httpClient := &InMemoryHTTPClient{server: s}
                return &TestDependencies{HTTPClient: httpClient}, func() {}
              }
              func integrationDependencies(t *testing.T) (*TestDependencies, func()) {
                ctx := context.Background()
                inMemoryStore, err := sqltesting.NewMemoryStore(ctx, sqltesting.NewTestingLog(t))
                require.NoError(t, err, "error creating in memory store")
                baseURL, stop := startTestingHTTPServer(t, inMemoryStore)
                return &TestDependencies{BaseURL: baseURL, HTTPClient: http.DefaultClient}, stop
              }
              func smokeDependencies(_ *testing.T) *TestDependencies {
                return &TestDependencies{BaseURL: os.Getenv("TARGET_URL"), HTTPClient: http.DefaultClient}
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide40/internal/server/http_test.go#L110-L167" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
        </section>
        <section>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="4,12,23,29,33" style="font-size:150%;">
              type TestDependencies struct {
                BaseURL    string
                HTTPClient HTTPClient
                DB         storage.Repository
              }
              func unitDependencies(t *testing.T) (*TestDependencies, func()) {
                repo := stubs.NewStubRepository(nil)
                s := server.NewHTTPServer(repo)
                httpClient := &InMemoryHTTPClient{server: s}
                return &TestDependencies{
                  HTTPClient: httpClient,
                  DB: repo,
                }, func() {}
              }
              func integrationDependencies(t *testing.T) (*TestDependencies, func()) {
                ctx := context.Background()
                inMemoryStore, err := sqltesting.NewMemoryStore(ctx, sqltesting.NewTestingLog(t))
                require.NoError(t, err, "error creating in memory store")
                baseURL, stop := startTestingHTTPServer(t, inMemoryStore)
                return &TestDependencies{
                  BaseURL:    baseURL,
                  HTTPClient: http.DefaultClient,
                  DB: inMemoryStore.Store,
                }, stop
              }
              func smokeDependencies(t *testing.T) *TestDependencies {
                ctx := context.Background()
                l := sqltesting.NewTestingLog(t)
                db := storage.InitializeStore(ctx, "mysql", os.Getenv("DB_CONN"), l, 1, 10*time.Second)
                return &TestDependencies{
                  BaseURL:    os.Getenv("TARGET_URL"),
                  HTTPClient: http.DefaultClient,
                  DB:         storage.NewSQLStore(db),
                }
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide41/internal/server/http_test.go#L110-L167" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
        </section>
        <section>
          <pre>
            <code class="hljs go" data-trim data-noescape data-line-numbers="3,7" style="font-size:150%;max-height:initial;">
              func TestShortURLReturnsFoundForValidURL(baseT *testing.T) {
                withDependencies(baseT, func(t *testing.T, deps *TestDependencies) {
                  repo, mocking := deps.DB.(*stubs.Repository)
                  input := "123456789012"
                  output := "https://www.digitalocean.com"
                  if mocking {
                    repo.Add(input, output)
                  } else {
                    // TODO: cadastrar a URL
                  }
                  httpReq, err := http.NewRequest(http.MethodGet, deps.BaseURL+"/s/"+input, nil)
                  require.NoError(t, err, "could not create GET / request")
                  resp, err := deps.HTTPClient.Do(httpReq)
                  require.NoError(t, err, "error making request %+v", httpReq)
                  require.Equal(t, http.StatusFound, resp.StatusCode, "expected status code to match for req %+v", httpReq)
                  body, err := readBodyFrom(resp)
                  require.NoError(t, err, "unexpected error reading response body")
                  assert.Equal(t, "", body, "expected body to match")
                  assert.Equal(t, output, resp.Header.Get("Location"), "expected location to match")
                })
              }
            </code>
          </pre>
          <a href="https://github.com/hugocorbucci/multitest-go-example/blob/slide42/internal/server/http_test.go#L85-L107" target="_blank" rel="noopener noreferrer">internal/server/http_test.go</a>
        </section>
        <section>
          <h1>Got it right?</h1>
          <h2 class="fragment">In the end, your test is also software</h2>
          <h2 class="fragment">Use the techniques you use<br/>in your production software</h2>
          <h2 class="fragment">for your test software</h2>
        </section>
        <section>
          <h1>But, Hugo, that's going to be super slow!</h1>
          <pre class="fragment">
            <code class="hljs shell" data-trim data-noescape data-line-numbers="" style="font-size:200%;max-height:initial;">
              $ for f in $(find . -name '*_test.go'); do grep 'func Test' $f; done | wc -l
              179
              $ for f in $(find . -name '*_test.go'); do cat $f; done | wc -l
              4893
              $ for f in $(find . -name '*.go' | grep -v '_test.go'); do cat $f; done | wc -l
              4811                              64           1528            190           7986
              $ time make test
              go test -tags=integration ./...
              ...
              74.55 real       145.33 user        27.76 sys
              $ PUBLIC_SMOKE_TESTS=true ENV=production make smoke_tests
              ../smoke_tests/bin/run
              ...
              [go] Task status: passed, took: 1m 46.536s
            </code>
          </pre>
        </section>
        <section>
          <h2>But, Hugo, what about flaky tests?</h2>
          <img src="images/PipelineActivity.png" alt="Pipeline activity showing 7 deployments in a row, all passing no failures" style="max-height: 75%">
        </section>
        <section>
          <h1>Other improvements we've had</h1>
          <h3 class="fragment">Use that test suite to verify generated DB query performance</h3>
          <h3 class="fragment">Run this suite synthetically outside of the system to find external problems</h3>
          <h3 class="fragment">Our architecture is testable by our users (since we test it like they would)</h3>
        </section>
        <section>
          <h1>Next steps</h1>
          <h3 class="fragment">Use the mock/fake setups in tests to validate compability with the actual results in real </h3>
          <h3 class="fragment">Improve the setup/preparation of data for test runs</h3>
          <h3 class="fragment">Try in other contexts</h3>
        </section>
        <section>
          <h1>That's it</h1>
          <h3>Thank you!</h3>
          <h3><a href="mailto:hcorbucci@digitalocean.com">hcorbucci@digitalocean.com</a></h3>
          <h3><a href="https://twitter.com/hugocorbucci">twitter.com/hugocorbucci</a></h3>
        </section>
      </div>
    </div>

    <script src="js/reveal.js"></script>

    <script>
      // More info about config & dependencies:
      // - https://github.com/hakimel/reveal.js#configuration
      // - https://github.com/hakimel/reveal.js#dependencies
      Reveal.initialize({
        controlsTutorial: false,
        slideNumber: true,
        hash: true,
        highlight: {
          highlightOnLoad: true
        },
        dependencies: [
          { src: 'plugin/markdown/marked.js' },
          { src: 'plugin/markdown/markdown.js' },
          { src: 'plugin/notes/notes.js', async: true },
          { src: 'plugin/highlight/highlight.js', async: true }
          // TODO: Reenable once made compatible with highlight plugin. Improving accessibility
          // { src: 'plugin/accessibility/helper.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });
    </script>
  </body>
</html>
